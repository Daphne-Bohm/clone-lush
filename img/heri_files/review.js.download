(function ($) {
  Drupal.behaviors.lush_review = {
    attach: function (context, settings) {
      $(document).ready(function () {

        $('.commerce_shipping .form-radios .form-item').each(function () {
          // Select first by default.
          var container = $(this);
          if ($('input', container).is(':checked')) {
            $('.label-container .delivery-option-padding', container).addClass('active');
          }
          $('label', container).unbind();

          $('label', container).click(function () {
            // Remove from all others.
            $('.commerce_shipping .form-radios .form-item .label-container .delivery-option-padding').removeClass('active');
            $('.label-container .delivery-option-padding', container).addClass('active');
            var input = $('input', container)[0];
            input.click();
          });

          // Add and show the delivery message.
          Drupal.deliveryMessage();
        });

        if ($('body').hasClass('page-checkout-review')) {
          $('body').once('review-message', function () {
            $('.field-widget-options-onof').each(function () {
              var container = $(this);
              // Hide input field.
              $('input.form-checkbox', container).hide();
              // Bind change event to input field.
              $('input.form-checkbox', container).change(function () {
                if ($(this).is(':checked')) {
                  if ($('textarea', container).is(":visible")) {
                  }
                  else {
                    $('textarea', container).slideDown();
                  }
                }
                else {
                  // Not checked.
                  if ($('textarea', container).is(":visible")) {
                    $('textarea', container).slideUp();
                  }
                }
              });
            });
          });

        }
      });
      $(document).ready(function () {
        var offsetHeight = $(".header").outerHeight(true);
        $('#scroll-to-reviews').on('click', function () {

          $('html, body').animate({
            scrollTop: $('#reviews-accordion').offset().top - offsetHeight
          }, 200);
        });
      });

      // Add and show the delivery message.
      Drupal.deliveryMessage();

      // Set telephone as payment option and submit the review page.
      var checkoutReviewForm = $('.commerce-checkout-form-review');
      // Otherwise could throw an error.
      if (checkoutReviewForm.length) {
        checkoutReviewForm.on('click', '#submit-pay-by-phone', function(e) {
          e.preventDefault();
          e.stopPropagation();

          var button = $(this);
          button.addClass('clicked');

          // If "Pay by telephone" was already selected, we wont have ajax request: just submit payment again.
          if ($.active == 0 && jQuery('#edit-commerce-payment-payment-method-pay-by-telephonecommerce-payment-pay-by-telephone').attr("checked") == "checked") {
            submit_review_page();
          }

          // Ensure the 'pay by telephone' method is selected.
          $('#edit-commerce-payment-payment-method-pay-by-telephonecommerce-payment-pay-by-telephone').trigger('click');
        });
      }

      $(document).ajaxStop(function () {
        submit_review_page();
      });

      function submit_review_page() {
        if ($('#submit-pay-by-phone').hasClass('clicked')) {
          var submit_button = $('input#edit-continue');
          if (!submit_button.hasClass('clicking')) {
            // Avoid double click.
            submit_button.addClass('clicking');
            submit_button.click();
          }
        }
      }
    }
  };

  Drupal.behaviors.rate_review = {
    attach: function (context, settings) {
      $('.rate-widget').once('rate-remove', function () {
        $(this).bind('eventAfterRate', function (event, data) {
          $(event.target).remove();
        });
      });
    }
  };

  Drupal.deliveryMessage = function () {
    // Check if we're on the review page and carrier service message is set.
    if ($('#commerce-shipping-service-ajax-wrapper').length > 0 && Drupal.settings.lush_commerce_shipping_services) {
      // Hide the message by default.
      $('.delivery-message').hide();

      // Check if we have any checkout or import tax message.
      show_message = ($('.delivery-option-padding.active').attr('data-checkout-message') == 'TRUE')
        || (Drupal.settings.lush_commerce_shipping_services.checkout_messages["import-tax-message"] != undefined)

      // Check if we have a checkout message.
      if (show_message) {
        // Get the active options carrier code.
        var carrier_code = $('.delivery-option-padding.active').attr('data-carrier-code');

        // Get the active options service code.
        var carrier_service_code = $('.delivery-option-padding.active').attr('data-carrier-service-code');

        messages = [];
        if (Drupal.settings.lush_commerce_shipping_services.checkout_messages[carrier_code + '-' + carrier_service_code]) {
          messages.push(Drupal.settings.lush_commerce_shipping_services.checkout_messages[carrier_code + '-' + carrier_service_code]);
        }

        if (Drupal.settings.lush_commerce_shipping_services.checkout_messages['import-tax-message']) {
          messages.push(Drupal.settings.lush_commerce_shipping_services.checkout_messages['import-tax-message']);
        }

        // Show the message if we have one.
        if (messages.length > 0) {
          // Append the message for later use if not already there.
          if ($('.delivery-message').length <= 0) {
            $('#commerce-shipping-service-ajax-wrapper').once().before("<div class='delivery-message sys-message'><div class='sys-message-content'>" + messages.join('<br><br>') + "</div></div>");
          }
          else {
            $('.delivery-message').addClass('sys-message').html("<div class='sys-message-content'>" + messages.join('<br><br>') + "</div></div>");
          }

          $('.delivery-message').show();
        }
      }
    }
  };

})(jQuery);
