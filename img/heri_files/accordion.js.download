(function ($) {
    Drupal.behaviors.accordion = {
        attach: function (context, settings) {

            //detect the width on page load
            $(document).ready(function(){
                var current_width = $(window).width();
                //do something with the width value here!

                if(current_width < 768){
                    deaccordionise();
                    accordionise();
                }
                else {
                    deaccordionise();
                }

                mega_accordionise();
                showStickers()
            });
            //update the width value when the browser is resized (useful for devices which switch from portrait to landscape)
            $(window).resize(function(){
                var current_width = $(window).width();
                //do something with the width value here!
                if(current_width < 768){
                    deaccordionise();
                    accordionise();
                }
                else {
                    deaccordionise();
                }
                showStickers()
            });
            $(window).scroll(function(){
                showStickers();
            });
            function accordionise() {
                $('.accordion').each(function(){
                    var accordion = $(this);
                    $('.accordion-label', this).click(function(event){
                        event.stopImmediatePropagation();
                        $(this).parent().find('.accordion-content').first().slideToggle();
                        $(this).parent().toggleClass('open');
                    });
                });
                $('#accordion-reviews').click(function(event){
                    event.stopImmediatePropagation();
                    $('#reviews-accordion').parent().find('.accordion-content').first().slideToggle();
                    $('#reviews-accordion').parent().toggleClass('open');
                });
            }
            function mega_accordionise() {
                $('.mega-accordion').once('mega_accordionise', function(){
                    var accordion = $(this);
                    $('.mega-accordion-label', this).click(function(event){
                        var label = $(this);
                        event.stopImmediatePropagation();
                        /*$('.accordion').each(function(){
                         $('.accordion-content', this).slideUp();
                         $(this).removeClass('open');
                         });*/
                        $('.mega-accordion-content', accordion).slideToggle();
                        $(accordion).toggleClass('open');
                    });
                });
            }
            function deaccordionise() {
                $('.accordion-label').unbind( "click" );
            }
            function showStickers() {
                $('.accordion').each(function() {
                    // get the height of #wrap
                    var top = $(this).offset();
                    var middle = $(window).height() / 2;
                    var scrollfromtop = $(document).scrollTop();

                    //If the scroll from the top equals the top of the document minus half the doc height... add class
                    if(scrollfromtop >= (top.top - middle - 200)) {
                        if($('.accordion-label', this).hasClass('active')) {
                            //Do nothing
                        }
                        else {
                            $('.accordion-label', this).css('margin-top','-50px');
                            $('.accordion-label', this).addClass('active');
                            $('.accordion-label', this).fadeTo( "slow" , 1);
                        }
                    }


                    /*var y = $(window).scrollTop();
                     if( y > (h*.25) && y < (h*.75) ){
                     // if we are show keyboardTips
                     $("#tips").fadeIn("slow");
                     } else {
                     $('#tips').fadeOut('slow');
                     }*/
                });
            }
        }
    };
})(jQuery);
