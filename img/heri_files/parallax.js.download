(function ($) {

    function parallax_scroll(hero){
        if(hero.attr('data-scrollable') == 'true') {

            var window_height = $(window).height();
            var scrolled = $(window).scrollTop();

            var herotop = (hero.offset().top)-$('header.header').height();
            var start_scrolling_at = window_height + scrolled;

            var when_bottom_of_image_comes_in = (window_height + scrolled) - herotop;
            if(when_bottom_of_image_comes_in >= 0) {
                var move_background =  -((when_bottom_of_image_comes_in * hero.attr('data-scroll-px')-6));
                $(hero).css('background-position', '0 ' + move_background + 'px');
            }
            //Only move the text and change opacity when the top of the hero is the same or less that the amount scrolled
            if(scrolled >= herotop) {
                $('.hero-center',hero).css('bottom', -((scrolled-herotop) * 0.3) + 'px');
                var heroscroll=1-((scrolled-herotop)/460);
                //console.log(heroscroll);
                $('.hero-center',hero).css('opacity', heroscroll);
            }
            else {
                $('.hero-center',hero).css('opacity', 1);
                $('.hero-center',hero).css('bottom', 0);
            }
        }
    }
    function get_body_width() {
        var attr = $('body').attr('data-body-width');
        // For some browsers, `attr` is undefined; for others,
        // `attr` is false.  Check for both.
        if (typeof attr !== 'undefined' && attr !== false) {

            return attr;
        }
        else {
            document.body.style.overflow = "hidden";
            var current_width = $(window).width();
            document.body.style.overflow = "";
            $('body').attr('data-body-width', current_width);
            return current_width;
        }
    }
    $(window).scroll(function(e){
        var width = get_body_width();

        if(width < 768) {

        }
        else {
            $('.hero.parallex').each(function(){
                var hero = $(this);
                parallax_scroll(hero);
            });
        }

    });
    $(document).ready(function(){
        parallax_heights();
    });

    $(window).resize(function() {
        $('body').removeAttr('data-body-width');
        var width = get_body_width();

        if(width > 768) {
            $('.hero.parallex').each(function(){
                var hero = $(this);
                parallax_scroll(hero);
            });
        }
    });
    function parallax_heights() {
        var width = get_body_width();

        if(width < 768) {

        }
        else {
            $('.hero.parallex').each(function(){
                var hero = $(this);
                var height = hero.height();

                //Create image from background image of this hero
                var img = new Image;
                img.src = hero.css('background-image').replace(/^url\(['"]?/,'').replace(/['"]?\)$/,'');

                var ratio = img.width/img.height;
                if(isNaN(ratio)) {
                    var ratio = 1.7777;
                }

                //Change this line if image ratio changes
                //console.log(img.width/img.height);
                //Height should be...
                var estimated_height = width/ratio;

                if(estimated_height >= height) {
                    hero.attr('data-scrollable','true');
                }
                //How much can scroll is equal to the hero height, minus the currently visible/ height of the whole page.
                var scroll_px = (estimated_height - height) / ($(window).height()+height);
                hero.attr('data-scroll-px',scroll_px);
                parallax_scroll(hero,width);


            });
        }
    }

})(jQuery);
