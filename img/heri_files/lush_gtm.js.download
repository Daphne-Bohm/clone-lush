(function ($) {

  /**
   * Provides real time GTM events tracking.
   */
  Drupal.behaviors.lushGTM = {
    attach: function (context, settings) {
      $('.gtm-product-track', context).each(function () {
        var $this = $(this);

        $this.find('a, .add-cart-button').each(function () {

          $(this).off('click.lush-gtm').on('click.lush-gtm', function (e) {
            var dataLayer = window.dataLayer || [];
            var nid = $this.attr('class').match(/\bnid-(\d+)\b/);

            if (nid && nid[1] !== undefined && (nid = nid[1])) {
              if (Drupal.settings && Drupal.settings.LushGTM && Drupal.settings.LushGTM.products
                && Drupal.settings.LushGTM.products[nid]) {

                dataLayer.push({
                  event: 'product_click',
                  ecommerce: {
                    click: {
                      actionField: {
                        list: Drupal.settings.LushGTM.products[nid].list
                      },
                      products: [
                        Drupal.settings.LushGTM.products[nid]
                      ]
                    }
                  }
                });
              }
            }
          });
        });
      });

      // Process delayed data layer data.
      if (Drupal.settings && Drupal.settings.LushGTM && Drupal.settings.LushGTM.delayed_datalayer) {
        for (i in Drupal.settings.LushGTM.delayed_datalayer) {
          if (Drupal.settings.LushGTM.delayed_datalayer.hasOwnProperty(i)) {
            var dataLayer = window.dataLayer || [];

            // Push item to  GTM data layer.
            dataLayer.push(Drupal.settings.LushGTM.delayed_datalayer[i]);
          }
        }

        // Unset pushed items to avoid double pushing on ajax behaviours attach.
        Drupal.settings.LushGTM.delayed_datalayer = [];
      }
    }
  };

  // Avoid js error if misc.js wasn't loaded.
  if (typeof Drupal.ajax != 'function') {
    return;
  }

  /**
   * Adds item to GTM data layer.
   */
  Drupal.ajax.prototype.commands.dataLayerAdd = function (ajax, response, status) {
    if (typeof response != 'undefined' && response.data) {
      var dataLayer = window.dataLayer || [];

      // Push item to  GTM data layer.
      dataLayer.push(response.data);
    }
  };

})(jQuery);
